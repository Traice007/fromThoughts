generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model User {
  id                    String     @id @default(cuid())
  name                  String?
  email                 String     @unique
  emailVerified         DateTime?
  image                 String?
  password              String?
  stripeCustomerId      String?    @unique
  subscriptionTier      String     @default("TRIAL")
  subscriptionStatus    String?
  subscriptionPeriodEnd DateTime?
  cancelAtPeriodEnd     Boolean    @default(false)
  paymentFailedAt       DateTime?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  accounts              Account[]
  forecasts             Forecast[]
  sessions              Session[]
  pipelineImports       PipelineImport[]

  @@index([email])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Forecast {
  id                         String           @id @default(cuid())
  userId                     String?
  email                      String
  companyName                String?
  currentRevenue             Int
  targetRevenue              Int
  timeHorizonMonths          Int
  monthlyInboundLeads        Int?
  marketingQualifiedAccounts Int?
  salesQualifiedLeads        Int?
  leadToMqaRate              Float?
  mqaToSqlRate               Float?
  sqlToCloseRate             Float?
  averageDealSize            Float?
  salesCycleLength           Int?
  industry                   String?
  targetMarket               String?
  idealCustomerProfile       String?
  competitivePosition        String?
  status                     String           @default("PENDING")
  gapAnalysis                String?
  recommendations            String?
  aiModelUsed                String?
  tokensUsed                 Int?
  processingTimeMs           Int?
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  crmIntegrations            CrmIntegration[]
  user                       User?            @relation(fields: [userId], references: [id])
  okrs                       Okr[]

  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("forecasts")
}

model Okr {
  id           String      @id @default(cuid())
  forecastId   String
  objective    String
  category     String
  priority     Int         @default(0)
  timeframe    String
  rationale    String?
  howToAchieve String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @default(now()) @updatedAt
  keyResults   KeyResult[]
  forecast     Forecast    @relation(fields: [forecastId], references: [id], onDelete: Cascade)

  @@index([forecastId])
  @@index([category])
  @@map("okrs")
}

model KeyResult {
  id              String              @id @default(cuid())
  okrId           String
  description     String
  metricName      String
  currentValue    Float?
  targetValue     Float
  unit            String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @default(now()) @updatedAt
  progressHistory KeyResultProgress[]
  okr             Okr                 @relation(fields: [okrId], references: [id], onDelete: Cascade)

  @@index([okrId])
  @@map("key_results")
}

model KeyResultProgress {
  id          String    @id @default(cuid())
  keyResultId String
  value       Float
  notes       String?
  createdAt   DateTime  @default(now())
  keyResult   KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)

  @@index([keyResultId, createdAt])
  @@map("key_result_progress")
}

model CrmIntegration {
  id             String    @id @default(cuid())
  forecastId     String
  provider       String
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  lastSyncAt     DateTime?
  syncStatus     String    @default("NOT_SYNCED")
  syncError      String?
  externalDealId String?
  externalNoteId String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  forecast       Forecast  @relation(fields: [forecastId], references: [id], onDelete: Cascade)

  @@unique([forecastId, provider])
  @@index([provider])
  @@index([syncStatus])
  @@map("crm_integrations")
}

model EmailDelivery {
  id          String    @id @default(cuid())
  forecastId  String    @unique
  email       String
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now())

  @@index([email])
  @@index([status])
  @@map("email_deliveries")
}

model SalesLead {
  id          String   @id @default(cuid())
  name        String
  email       String
  companyWebsite String?
  teamSize       String?
  message     String?
  status      String   @default("NEW")
  createdAt   DateTime @default(now())

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("sales_leads")
}

model PipelineImport {
  id                 String   @id @default(cuid())
  userId             String
  source             String   // "csv" or "paste"
  fileName           String?
  totalDeals         Int
  totalValue         Float
  avgDealSize        Float
  avgSalesCycleDays  Int?
  importedAt         DateTime @default(now())
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deals              Deal[]

  @@index([userId])
  @@map("pipeline_imports")
}

model Deal {
  id               String          @id @default(cuid())
  pipelineImportId String
  dealName         String
  stage            String
  value            Float
  closeDate        DateTime?
  createdDate      DateTime?
  contactName      String?
  companyName      String?
  probability      Float?
  notes            String?
  pipelineImport   PipelineImport  @relation(fields: [pipelineImportId], references: [id], onDelete: Cascade)

  @@index([pipelineImportId])
  @@map("deals")
}
